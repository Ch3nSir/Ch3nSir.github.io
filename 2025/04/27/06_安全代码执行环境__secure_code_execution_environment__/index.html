<!DOCTYPE html>
<html>
	<head>
		
<title>AutoSafeCoder-Secure Code Execution Environment-ChenSir's Blog</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" type="image/x-icon" href="/image/favicon.ico">

<link rel="stylesheet" href="/css/index.css">



<meta name="keywords" content="UESTC,">
<meta name="description" content="genshin impart">


<script src="/js/jquery.min.js"></script>


<script src="/js/index.js"></script>


<script src="/js/fancybox.umd.js"></script>


<script src="/js/fancybox-images.js"></script>


<script src="/js/gitalk.min.js"></script>


<script src="/js/hljs.min.js"></script>
 
<script>hljs.initHighlightingOnLoad();</script>

	<meta name="generator" content="Hexo 6.2.0"></head>

	<body>
		
	<div class="header">
		<div class="header-top" id="header-top">
			<div class="h-left">
				<a href="/">
					<img src="/image/logo.png" alt="Quiet">
				</a>
			</div>
			<div class="h-right">
				<ul>
					
						
								<li>
									<a href="/">
										HOME
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/archives">
										ARCHIVE
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/categories">
										CATEGORIES
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/tags">
										TAGS
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/links">
										LINKS
									</a>
									<span class="dot"></span>
								</li>
								
									
						
								<li>
									<a href="/about">
										ABOUT
									</a>
									<span class="dot"></span>
								</li>
								
									
				</ul>
			</div>
			<div class="h-right-close">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
					<path fill="none" d="M0 0h24v24H0z" />
					<path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z" fill="rgba(68,68,68,1)" />
				</svg>
			</div>
		</div>
	</div>
	<div class="sidebar">
    <div class="topo">
        <h2>ChenSir</h2>
    </div>
    <ul>
        
        <li>
            <a href="/">HOME</a>
        </li>
        
        <li>
            <a href="/archives">ARCHIVE</a>
        </li>
        
        <li>
            <a href="/categories">CATEGORIES</a>
        </li>
        
        <li>
            <a href="/tags">TAGS</a>
        </li>
        
        <li>
            <a href="/links">LINKS</a>
        </li>
        
        <li>
            <a href="/about">ABOUT</a>
        </li>
        
    </ul>
    <div class="my_foot">
        
        <a target="_blank" rel="noopener" href="https://github.com/Ch3nSir">
            <img src="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quiet主题">
        </a>
        
    </div>
</div>
<div class='shelter'>
</div>
<style>
    .shelter{
        background-color: #333;
        opacity:0.5;
        cursor: pointer;
        display: none; 
        position: fixed;
        left: 0;
        top: 0; 
        right: 0;
        bottom: 0;
        z-index: 1998;
    }
    .sidebar {
        width: 0;
        height: 100%;
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        z-index: 1999;
        text-align: center;
        box-shadow: -6px 0 20px rgba(98, 94, 94, .815)
    }

    .topo {
        width: 100%;
        height: 200px;
        background: url(https://api.ixiaowai.cn/gqapi/gqapi.php) no-repeat;
        background-size: 100% 100%;
        position: relative;
        display: flex;
        align-items: flex-end
    }

    .topo h2 {
        color: #fff;
        z-index: 1;
        position: relative;
        margin: 0 0 10px 10px;
        font-size: 1.2em;
        box-sizing: border-box
    }

    .topo:before {
        content: '';
        background-image: url(/image/pattern.png);
        background-repeat: repeat;
        height: 100%;
        left: 0;
        position: absolute;
        top: 0;
        width: 100%;
        z-index: 1
    }

    .sidebar ul {
        width: 100%;
        margin-top: 50px
    }

    .sidebar ul li {
        height: 50px;
        list-style: none;
        font-size: 1.2em;
        text-align: right;
        margin-right: 10px
    }

    .sidebar ul li a {
        display: grid;
        color: #5d606a;
        text-overflow: ellipsis;
        width: 100%;
        text-decoration: none
    }

    .my_foot {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        position: absolute;
        bottom: 0
    }

    .my_foot a {
        text-decoration: none;
        margin-right: 10px;
        display: inline-block
    }

    .my_foot a img {
        width: 30px;
        height: 30px
    }
</style>

<script>
    $( function () {
	$( '.h-right-close>svg' )
		.click( function () {
			$( '.sidebar' )
				.animate( {
					width: "66%"
				}, 500 );
			$( '.shelter' )
				.fadeIn( "slow" )
		} );
	$( '.shelter' )
		.click( function ( e ) {
			$( '.sidebar' )
				.animate( {
					width: "0"
				}, 500 );
			$( '.shelter' )
				.fadeOut( "slow" )
		} )
} )

</script>

<div class="post">
    <div class="post-header-background post-header-img"
    style="background: url('https://api.ixiaowai.cn/gqapi/gqapi.php')" 
>
    <div class="post-header-background-content">
        <ul class="post-header-tag">
            
            
            <li><a href="/tags/UESTC">UESTC</a></li>
            
            
        </ul>
        
        <h1>AutoSafeCoder-Secure Code Execution Environment</h1>
        <div class="post-header-info">
            <div class="post-header-info-author">
                
                    <svg t="1604839279282" class="icon" viewBox="0 0 1024 1024" version="1.1"
                        xmlns="http://www.w3.org/2000/svg" p-id="2901" width="20" height="20">
                        <path
                            d="M513 956.3c-247.7 0-448-200.3-448-448S265.3 66.2 513 66.2s448 200.3 448 448-200.3 442.1-448 442.1z m0-830.9c-212.2 0-388.8 170.7-388.8 388.8C124.2 726.3 294.9 903 513 903c212.2 0 388.8-170.7 388.8-388.8S725.2 125.4 513 125.4z m0 430.2c-94.2 0-170.7-76.5-170.7-170.7S418.8 207.8 513 207.8s170.7 76.5 170.7 170.7S607.2 555.6 513 555.6z m0-289.1c-64.6 0-112 52.8-112 112s47.4 117.9 112 117.9 112-52.8 112-112-47.4-117.9-112-117.9z m0 689.8c-135.7 0-259-58.7-341.9-158.9l-11.8-17.8 11.8-17.8c76.5-117.9 206.2-188.5 347.8-188.5 135.7 0 265 64.6 341.9 182.6l11.8 17.8-11.8 17.8C778 897.1 648.7 956.3 513 956.3zM230.3 773.2C300.9 849.7 406.9 897 513 897c112 0 218.1-47.4 288.6-129.8-70.5-88.2-170.7-135.6-282.7-135.6s-218.1 53.3-288.6 141.6z"
                            p-id="2902" fill="#ffffff"></path>
                    </svg>
                    
                <span class="post-header-info-author-text"> <a href="../../about">ChenSir</a></span>
                <div class="post-header-info-author-categories">
                    
                         <a href="../../categories/UESTC/" target="_blank" >UESTC</a>
                    
                </div>
                <p>2025-04-27 00:00:06</p>
            </div>
        </div>
    </div>
</div>
    <div class="post-content" id="content">
  
  <div id="article" class="post-content-info">
    

    <h1 id="Chapter-6-安全代码执行环境-Secure-Code-Execution-Environment"><a href="#Chapter-6-安全代码执行环境-Secure-Code-Execution-Environment" class="headerlink" title="Chapter 6: 安全代码执行环境 (Secure Code Execution Environment)"></a>Chapter 6: 安全代码执行环境 (Secure Code Execution Environment)</h1><p>欢迎来到 AutoSafeCoder 教程的第六章！在上一章 <a href="05_%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95%E6%89%A7%E8%A1%8C%E5%99%A8__fuzzing_executor__.md">第 5 章：模糊测试执行器 (Fuzzing Executor)</a> 中，我们了解了 AutoSafeCoder 如何像“碰撞测试工程师”一样，使用各种输入来实际运行并测试代码。但我们面临一个重要的问题：<a href="02_%E7%A8%8B%E5%BA%8F%E5%91%98%E6%99%BA%E8%83%BD%E4%BD%93__programmer_agent__.md">程序员智能体</a>生成的代码可能来自强大的<a href="07_%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E4%BA%A4%E4%BA%92%E6%8E%A5%E5%8F%A3__large_language_model_interaction_interface__.md">大语言模型</a>，这些代码不一定总是安全的。如果代码包含恶意指令（比如删除文件）或者有严重的 Bug 导致失控，直接运行它可能会损坏我们的计算机系统！</p>
<p>想象一下，你是一位化学家，需要处理一些非常危险、可能会爆炸或泄漏的有毒化学品。你肯定不会在开放的桌面上进行实验，对吧？你会使用一个特殊的<strong>通风橱</strong>或者<strong>隔离操作箱</strong>。这个设备可以让你安全地操作化学品，即使发生意外，也能把危害控制在箱子内部，保护你和外部环境的安全。</p>
<p>在 AutoSafeCoder 中，<strong>安全代码执行环境 (Secure Code Execution Environment)</strong> 就扮演着这个“通风橱”或“隔离箱”的角色。它为<a href="05_%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95%E6%89%A7%E8%A1%8C%E5%99%A8__fuzzing_executor__.md">模糊测试执行器</a>提供了一个受控的“沙盒”（Sandbox），专门用来运行那些可能不安全的代码。</p>
<h2 id="什么是安全代码执行环境？"><a href="#什么是安全代码执行环境？" class="headerlink" title="什么是安全代码执行环境？"></a>什么是安全代码执行环境？</h2><p><strong>安全代码执行环境</strong>（我们常称之为“沙盒”）是 AutoSafeCoder 为了安全地运行来自大模型的、潜在不可信代码而设计的一系列保护措施。它的核心目标是：<strong>限制代码的能力，防止它搞破坏</strong>。</p>
<p>这个环境主要通过以下方式实现保护：</p>
<ol>
<li>**权限限制 (Permission Restriction)**：就像隔离箱不允许你直接触摸外面的东西一样，沙盒会阻止代码执行危险的操作。例如：<ul>
<li>禁止访问文件系统（不能随意读写硬盘上的文件）。</li>
<li>禁止建立网络连接（不能访问互联网或局域网）。</li>
<li>禁止执行危险的系统调用（比如创建新进程、修改系统设置等）。</li>
</ul>
</li>
<li>**资源限制 (Resource Limitation)**：为了防止代码因为 Bug（比如死循环）而耗尽系统资源，沙盒会限制它能使用的资源。例如：<ul>
<li><strong>时间限制</strong>：代码必须在指定的时间内（比如几秒钟）完成运行，否则会被强制终止。这可以防止无限循环的代码卡死系统。</li>
<li><strong>内存限制</strong>：代码能使用的内存量也可能受到限制（虽然在 <code>executor_agent_safe.py</code> 的示例中，时间限制更常用）。</li>
</ul>
</li>
<li>**执行隔离 (Execution Isolation)**：就像隔离箱是一个独立的物理空间，沙盒通常会将代码的执行放在一个独立的进程中。这意味着即使代码崩溃或出错，也只会影响到它自己所在的那个独立进程，而不会拖垮 AutoSafeCoder 的主程序或其他系统进程。</li>
</ol>
<p>把这个环境想象成一个给代码准备的“带软垫的房间”。代码可以在里面运行，但它不能打开门窗（网络&#x2F;文件访问受限），不能大喊大叫太久（时间受限），也不能破坏房间里的家具（系统调用受限）。即使它在里面发疯崩溃了，也只影响这个房间，不会干扰到外面。</p>
<h2 id="如何使用这个安全环境？"><a href="#如何使用这个安全环境？" class="headerlink" title="如何使用这个安全环境？"></a>如何使用这个安全环境？</h2><p>与我们之前介绍的各个“智能体”不同，安全代码执行环境<strong>不是一个单独的类或对象</strong>让我们直接调用。它更像是一套<strong>内置在<a href="05_%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95%E6%89%A7%E8%A1%8C%E5%99%A8__fuzzing_executor__.md">模糊测试执行器</a>（即 <code>execute_fuzz</code> 函数）中的安全机制</strong>。</p>
<p>当我们调用 <code>execute_fuzz</code> 来运行代码时，这些安全措施就已经自动启动并生效了。我们不需要显式地“开启”沙盒。</p>
<p>回顾一下我们在上一章调用 <code>execute_fuzz</code> 的代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># main.py (run 方法片段 - 简化)</span>
<span class="token keyword">from</span> executor_agent_safe <span class="token keyword">import</span> execute_fuzz <span class="token comment"># 导入执行函数</span>

<span class="token comment"># ... (在 MultiAgentSystem 的 run 方法中) ...</span>
<span class="token keyword">for</span> iteration <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>iterations<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ... (准备 current_inputs) ...</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 调用 execute_fuzz 时，安全环境就在后台工作了</span>
        result_str<span class="token punctuation">,</span> passed<span class="token punctuation">,</span> inputs_used<span class="token punctuation">,</span> func_name <span class="token operator">=</span> execute_fuzz<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>code<span class="token punctuation">,</span>        <span class="token comment"># 潜在不安全的代码</span>
            current_inputs<span class="token punctuation">,</span>   <span class="token comment"># 测试输入</span>
            <span class="token number">3</span>                 <span class="token comment"># &lt;&lt;&lt;--- 时间限制（安全环境的一部分）</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># ... (异常处理) ...</span>

    <span class="token comment"># ... (检查结果 passed) ...</span>
    <span class="token comment"># ... (变异输入) ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>代码解释:</strong></p>
<ul>
<li>当我们调用 <code>execute_fuzz(self.code, current_inputs, 3)</code> 时，这个函数内部就会自动应用安全代码执行环境的各种措施。</li>
<li>我们传入的 <code>3</code>（秒）就是<strong>时间限制</strong>，这是安全环境提供的一个重要功能。如果 <code>self.code</code> 运行超过 3 秒，<code>execute_fuzz</code> 内部的机制会强制终止它，并返回 “timed out” 结果。</li>
<li>虽然我们没有直接看到，但在 <code>execute_fuzz</code> 内部，代码的执行已经被<strong>隔离</strong>到了一个单独的进程中，并且许多<strong>危险的权限</strong>（如文件访问、网络）已经被限制了。</li>
</ul>
<p>所以，使用这个安全环境非常简单：<strong>只要你通过 <code>execute_fuzz</code> 来运行代码，你就已经在使用它提供的保护了！</strong></p>
<h2 id="内部实现揭秘"><a href="#内部实现揭秘" class="headerlink" title="内部实现揭秘"></a>内部实现揭秘</h2><p>现在，让我们更深入地了解一下 <code>execute_fuzz</code> 函数（位于 <code>executor_agent_safe.py</code>）是如何构建和利用这个安全环境的。</p>
<p><strong>非代码流程图解:</strong></p>
<p>当 <code>execute_fuzz</code> 被调用时，它如何搭建安全环境并执行代码？</p>
<pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">sequenceDiagram</span>
    <span class="token keyword">participant</span> EF as 执行器 <span class="token text string">(execute_fuzz 父进程)</span>
    <span class="token keyword">participant</span> MP as Python多进程模块
    <span class="token keyword">participant</span> ChildP as 子进程 <span class="token text string">(运行 unsafe_execute)</span>
    <span class="token keyword">participant</span> Guard as 安全防护 <span class="token text string">(reliability_guard)</span>
    <span class="token keyword">participant</span> Code as 被测代码

    EF<span class="token arrow operator">->></span>MP<span class="token operator">:</span> 请求启动新进程运行 unsafe_execute
    MP<span class="token arrow operator">->></span>ChildP<span class="token operator">:</span> 创建并启动子进程 <span class="token text string">(实现隔离)</span>
    ChildP<span class="token arrow operator">->></span>Guard<span class="token operator">:</span> 调用 reliability_guard<span class="token punctuation">(</span><span class="token punctuation">)</span>
    Guard<span class="token arrow operator">->></span>ChildP<span class="token operator">:</span> 禁用危险函数/系统调用 <span class="token text string">(限制权限)</span>
    ChildP<span class="token arrow operator">->></span>MP<span class="token operator">:</span> 设置信号处理和计时器 <span class="token text string">(时间限制)</span>
    ChildP<span class="token arrow operator">->></span>Code<span class="token operator">:</span> 在受限环境和时间内执行代码 <span class="token text string">(exec)</span>
    <span class="token keyword">alt</span> 代码正常或出错
        Code<span class="token arrow operator">-->></span>ChildP<span class="token operator">:</span> 返回结果或抛出异常
    <span class="token keyword">else</span> 代码超时
        MP<span class="token arrow operator">-->></span>ChildP<span class="token operator">:</span> 发送超时信号 <span class="token text string">(SIGALRM)</span>
        ChildP<span class="token arrow operator">->></span>ChildP<span class="token operator">:</span> 捕获超时信号，抛出 TimeoutException
    <span class="token keyword">end</span>
    ChildP<span class="token arrow operator">->></span>EF<span class="token operator">:</span> 通过共享内存返回结果 <span class="token text string">("passed", "failed", "timed out")</span>
    EF<span class="token arrow operator">->></span>EF<span class="token operator">:</span> 获取子进程结果<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>图解说明:</strong></p>
<ol>
<li><strong>隔离 (Isolation)</strong>: <code>execute_fuzz</code> (父进程) 使用 <code>multiprocessing</code> 模块 (MP) 创建一个<strong>子进程</strong> (ChildP) 来运行实际的代码执行逻辑（在 <code>unsafe_execute</code> 函数内）。这是实现隔离的第一步。</li>
<li><strong>权限限制 (Permission Restriction)</strong>: 在子进程开始执行用户代码之前，它会调用 <code>reliability_guard()</code> 函数 (Guard)。这个函数会禁用 Python 内置库或 <code>os</code> 模块中很多可能被滥用的函数（比如 <code>os.kill</code>, <code>os.remove</code>, <code>shutil.rmtree</code> 等）。</li>
<li><strong>时间限制 (Time Limit)</strong>: 子进程在执行用户代码 (<code>exec</code>) 之前，会使用 <code>signal</code> 模块设置一个闹钟 (<code>setitimer</code>)。如果在指定时间内代码没有执行完，操作系统会发送一个信号 (<code>SIGALRM</code>) 给子进程，子进程捕获这个信号并抛出 <code>TimeoutException</code>，从而中断执行。</li>
<li><strong>受控执行</strong>: 最后，子进程在一个受控的环境下（比如通过 <code>swallow_io</code> 抑制了标准输出&#x2F;错误流）使用 <code>exec()</code> 来执行用户代码。</li>
<li><strong>结果反馈</strong>: 子进程将执行结果（成功、失败及原因、或超时）通过进程间通信（<code>Manager.list</code>）返回给父进程 <code>execute_fuzz</code>。</li>
</ol>
<p>通过这几层保护，<code>execute_fuzz</code> 尽可能地确保了运行未知代码的安全性。</p>
<p><strong>代码层面的深入了解:</strong></p>
<p>让我们看看 <code>executor_agent_safe.py</code> 中实现这些安全机制的关键代码片段。</p>
<p><strong>1. 进程隔离 (<code>multiprocessing</code>)</strong></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># executor_agent_safe.py (execute_fuzz 函数片段)</span>
<span class="token keyword">import</span> multiprocessing

<span class="token comment"># ... (unsafe_execute 函数定义) ...</span>

<span class="token keyword">def</span> <span class="token function">execute_fuzz</span><span class="token punctuation">(</span>completion<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> input_json<span class="token punctuation">,</span> timeout<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ... (创建 manager 和共享列表 result, inputs_list, func_names) ...</span>

    <span class="token comment"># === 关键：创建子进程 ===</span>
    <span class="token comment"># 将实际执行代码的任务交给 unsafe_execute 函数，并在一个新进程中运行它</span>
    p <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span>unsafe_execute<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 启动子进程</span>

    <span class="token comment"># === 关键：等待并处理子进程 ===</span>
    p<span class="token punctuation">.</span>join<span class="token punctuation">(</span>timeout<span class="token operator">=</span>timeout <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 等待子进程结束，有超时保护</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>is_alive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 如果超时后子进程还在运行</span>
        p<span class="token punctuation">.</span>kill<span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment"># 强制终止，防止卡死</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> result<span class="token punctuation">:</span>
             result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"timed out"</span><span class="token punctuation">)</span>

    <span class="token comment"># ... (从共享列表获取结果并返回) ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>代码解释:</strong></p>
<ul>
<li><code>multiprocessing.Process(target=unsafe_execute)</code> 创建了一个新的进程，这个进程会执行 <code>unsafe_execute</code> 函数中的所有逻辑（包括权限限制、时间限制和代码执行）。</li>
<li><code>p.start()</code> 启动这个独立的进程。</li>
<li><code>p.join()</code> 等待子进程完成。如果子进程因为内部超时或其他原因卡住了，<code>join</code> 也会超时，然后 <code>p.kill()</code> 会强制结束它，确保主程序不会被无限期阻塞。这就是<strong>执行隔离</strong>的核心。</li>
</ul>
<p><strong>2. 权限限制 (<code>reliability_guard</code>)</strong></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># executor_agent_safe.py (reliability_guard 函数片段 - 简化)</span>
<span class="token keyword">import</span> builtins
<span class="token keyword">import</span> os
<span class="token keyword">import</span> shutil
<span class="token keyword">import</span> subprocess
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> faulthandler

<span class="token keyword">def</span> <span class="token function">reliability_guard</span><span class="token punctuation">(</span>maximum_memory_bytes<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    禁用各种危险函数，防止代码干扰测试或破坏系统。
    警告: 这不是一个完美的沙盒！
    """</span>
    <span class="token comment"># ... (内存限制设置，可选) ...</span>

    faulthandler<span class="token punctuation">.</span>disable<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 禁用Python错误追溯增强，减少信息泄露</span>

    <span class="token comment"># 禁用退出函数</span>
    builtins<span class="token punctuation">.</span>exit <span class="token operator">=</span> <span class="token boolean">None</span>
    builtins<span class="token punctuation">.</span>quit <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token comment"># 禁用 os 模块中一系列危险操作</span>
    os<span class="token punctuation">.</span>kill <span class="token operator">=</span> <span class="token boolean">None</span>        <span class="token comment"># 禁止杀进程</span>
    os<span class="token punctuation">.</span>system <span class="token operator">=</span> <span class="token boolean">None</span>      <span class="token comment"># 禁止执行shell命令</span>
    os<span class="token punctuation">.</span>remove <span class="token operator">=</span> <span class="token boolean">None</span>      <span class="token comment"># 禁止删除文件</span>
    os<span class="token punctuation">.</span>rmdir <span class="token operator">=</span> <span class="token boolean">None</span>       <span class="token comment"># 禁止删除目录</span>
    os<span class="token punctuation">.</span>fork <span class="token operator">=</span> <span class="token boolean">None</span>        <span class="token comment"># 禁止创建子进程 (fork bomb)</span>
    <span class="token comment"># ... (还有很多其他被禁用的 os 函数) ...</span>

    <span class="token comment"># 禁用 shutil 模块中的危险操作</span>
    shutil<span class="token punctuation">.</span>rmtree <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 禁止递归删除目录树</span>
    <span class="token comment"># ...</span>

    <span class="token comment"># 禁用 subprocess 模块</span>
    subprocess<span class="token punctuation">.</span>Popen <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token comment"># 禁止启动外部程序</span>

    <span class="token comment"># 禁用 help()</span>
    __builtins__<span class="token punctuation">[</span><span class="token string">'help'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token comment"># 移除一些可能被滥用的模块</span>
    sys<span class="token punctuation">.</span>modules<span class="token punctuation">[</span><span class="token string">'ipdb'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token comment"># 调试器</span>
    <span class="token comment"># ... (还有 joblib, psutil, tkinter 等) ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>代码解释:</strong></p>
<ul>
<li><code>reliability_guard</code> 函数通过将很多内置函数、<code>os</code> 模块函数、<code>shutil</code> 模块函数以及 <code>subprocess</code> 等设置为 <code>None</code>，来直接<strong>禁用</strong>这些功能。</li>
<li>当被测代码尝试调用比如 <code>os.remove(&quot;some_file&quot;)</code> 时，它实际上会尝试调用 <code>None</code>，这通常会导致一个 <code>TypeError</code>，从而阻止了危险操作的执行。这就是<strong>权限限制</strong>的核心实现方式。</li>
</ul>
<p><strong>3. 时间限制 (<code>time_limit</code>)</strong></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># executor_agent_safe.py (time_limit 上下文管理器片段)</span>
<span class="token keyword">import</span> signal
<span class="token keyword">import</span> contextlib

<span class="token keyword">class</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 自定义超时异常</span>
    <span class="token keyword">pass</span>

<span class="token decorator annotation punctuation">@contextlib<span class="token punctuation">.</span>contextmanager</span>
<span class="token keyword">def</span> <span class="token function">time_limit</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 定义超时发生时要调用的处理函数</span>
    <span class="token keyword">def</span> <span class="token function">signal_handler</span><span class="token punctuation">(</span>signum<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 当接收到 SIGALRM 信号时，抛出自定义的 TimeoutException</span>
        <span class="token keyword">raise</span> TimeoutException<span class="token punctuation">(</span><span class="token string">"Timed out!"</span><span class="token punctuation">)</span>

    <span class="token comment"># 设置定时器：在 'seconds' 秒后发送 SIGALRM 信号</span>
    signal<span class="token punctuation">.</span>setitimer<span class="token punctuation">(</span>signal<span class="token punctuation">.</span>ITIMER_REAL<span class="token punctuation">,</span> seconds<span class="token punctuation">)</span>
    <span class="token comment"># 注册信号处理器：当收到 SIGALRM 信号时，调用 signal_handler</span>
    signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span>signal<span class="token punctuation">.</span>SIGALRM<span class="token punctuation">,</span> signal_handler<span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># yield 语句是关键，它使得 time_limit 可以像 with 语句一样使用</span>
        <span class="token comment"># with time_limit(3):</span>
        <span class="token comment">#     # 这部分代码会受到时间限制</span>
        <span class="token comment">#     exec(...)</span>
        <span class="token keyword">yield</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token comment"># 无论 try 块中的代码是否成功、出错或超时，</span>
        <span class="token comment"># 最终都会执行 finally 块，取消定时器</span>
        signal<span class="token punctuation">.</span>setitimer<span class="token punctuation">(</span>signal<span class="token punctuation">.</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>代码解释:</strong></p>
<ul>
<li><code>time_limit</code> 是一个<a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/contextlib.html">上下文管理器 (Context Manager)</a>，让我们能用 <code>with</code> 语句方便地应用时间限制。</li>
<li>它使用 <code>signal.setitimer(signal.ITIMER_REAL, seconds)</code> 来启动一个倒计时。</li>
<li>它使用 <code>signal.signal(signal.SIGALRM, signal_handler)</code> 来告诉操作系统：“如果倒计时结束（收到 <code>SIGALRM</code> 信号），请调用 <code>signal_handler</code> 函数。”</li>
<li><code>signal_handler</code> 函数非常简单，它只是抛出一个我们自定义的 <code>TimeoutException</code> 异常。</li>
<li>在 <code>unsafe_execute</code> 函数中，<code>exec()</code> 调用被包裹在 <code>with time_limit(timeout):</code> 块内。如果 <code>exec</code> 在指定时间内没有完成，<code>signal_handler</code> 被调用，抛出 <code>TimeoutException</code>，这个异常会被 <code>unsafe_execute</code> 中的 <code>except TimeoutException:</code> 块捕获，然后记录结果为 “timed out”。</li>
<li><code>finally</code> 块确保无论如何定时器最终都会被取消。这就是<strong>资源限制（时间）</strong> 的核心实现。</li>
</ul>
<p><strong>其他措施:</strong></p>
<ul>
<li><strong>临时目录 (<code>create_tempdir</code>)</strong>: 代码执行被限制在一个临时目录中，执行结束后该目录会被自动清理，防止留下垃圾文件。</li>
<li><strong>IO 抑制 (<code>swallow_io</code>)</strong>: 被测代码的标准输出和错误输出被重定向，防止它们干扰 AutoSafeCoder 主程序的日志。</li>
</ul>
<p>通过综合运用这些技术（进程隔离、权限限制、时间限制、临时环境），AutoSafeCoder 构建了一个相对可靠的安全执行环境，用于运行潜在有风险的代码。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在本章中，我们深入探讨了 AutoSafeCoder 用于安全运行代码的“隔离箱”——**安全代码执行环境 (Secure Code Execution Environment)**。我们了解到：</p>
<ul>
<li>它的存在是为了安全地运行来自大模型、可能不安全的代码，防止其破坏宿主系统。</li>
<li>它像一个化学通风橱，通过<strong>隔离执行</strong>、<strong>限制权限</strong>（禁止危险操作如文件访问、网络连接）和<strong>限制资源</strong>（如运行时间）来提供保护。</li>
<li>这个环境不是一个独立的智能体，而是由<a href="05_%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95%E6%89%A7%E8%A1%8C%E5%99%A8__fuzzing_executor__.md">模糊测试执行器</a>（<code>execute_fuzz</code> 函数）内部实现和使用的一系列安全机制。</li>
<li>我们通过分析 <code>executor_agent_safe.py</code> 中的代码，了解了其关键实现技术：<ul>
<li>使用 <code>multiprocessing</code> 实现<strong>进程隔离</strong>。</li>
<li>使用 <code>reliability_guard</code> 函数禁用危险函数，实现<strong>权限限制</strong>。</li>
<li>使用 <code>time_limit</code> 上下文管理器和 <code>signal</code> 模块实现<strong>时间限制</strong>。</li>
</ul>
</li>
</ul>
<p>这个安全环境是 AutoSafeCoder 能够进行模糊测试、动态发现代码问题的基石，确保了测试过程本身不会带来额外的风险。</p>
<p>至此，我们已经了解了 AutoSafeCoder 中负责代码生成、静态分析、模糊测试输入生成、模糊测试执行以及安全执行环境的核心组件。还剩下最后一个关键部分：所有这些智能体（尤其是程序员智能体和静态分析器）都需要与强大的大语言模型进行交互。它们是如何做到的呢？</p>
<p><strong>下一章预告:</strong> <a href="07_%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E4%BA%A4%E4%BA%92%E6%8E%A5%E5%8F%A3__large_language_model_interaction_interface__.md">第 7 章：大语言模型交互接口 (Large Language Model Interaction Interface)</a> - 我们将探索 AutoSafeCoder 是如何与背后的大语言模型（如 GPT）进行通信的。</p>
<hr>
<p>Generated by <a target="_blank" rel="noopener" href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>

  </div>
  <div id=""></div>
</div>

<script>
  
Fancybox.bind('[data-fancybox="fancybox-gallery-img"]', {
  dragToClose: true,
  Toolbar: true,
  closeButton: "top",
  Image: {
    zoom: true,
  },
  on: {
    initCarousel: (fancybox) => {
      const slide = fancybox.Carousel.slides[fancybox.Carousel.page];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
    "Carousel.change": (fancybox, carousel, to, from) => {
      const slide = carousel.slides[to];
      fancybox.$container.style.setProperty(
        "--bg-image",
        `url("${slide.$thumb.src}")`
      );
    },
  },
});
</script>

<style>
    #noneimg img {
        display: none;
        z-index: 9999;
        /* width: 600px !important; */
        min-width: 0%;
        max-width: 90%;
        max-height: 80%;
        border-radius: 0px;
        position: fixed;
        box-shadow: 0 0 0px #c3c3c300 !important;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        margin: auto !important;
    }

    @media screen and (max-width:600px) {
        #noneimg img {
            max-width: 88%
        }
    }
</style>

    <div class="post-paging">
    
    <a href="/2025/04/27/05_%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95%E6%89%A7%E8%A1%8C%E5%99%A8__fuzzing_executor__/">
        <div class="post-paging-last">
            <span>上一篇</span>
            <p>AutoSafeCoder-Fuzzing Executor</p>
        </div>
    </a>
    

    
    <a href="/2025/04/27/04_%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95%E8%BE%93%E5%85%A5%E7%94%9F%E6%88%90%E5%99%A8__fuzzing_input_generator__/">
        <div class="post-paging-next">
            <span>下一篇</span>
            <p>AutoSafeCoder-Fuzzing Input Generator</p>
        </div>
    </a>
    
</div>
</div>
		
<div class="footer">
	<div class="Copyright">
		©2025 By ChenSir. 主题：<a
			style="text-decoration: none;display: contents; color: #898F9F;"
			target="_blank" rel="noopener" href="https://github.com/qiaobug/hexo-theme-quiet">Quiet</a>
	</div>
	<div class="contact">
		
		<a target="_blank" rel="noopener" href="https://github.com/Ch3nSir">
			<img src="https://cdn.jsdelivr.net/gh/duogongneng/MyBlogImg/imggithub.png" alt="Quiet主题">
		</a>
		
	</div>
</div>

<script src="/js/gotop.js"></script>


<style type="text/css">
    @media screen and (min-width: 600px) {
        .goTop>span {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            opacity: 0.8;
            background: rgba(18, 24, 58, 0.06);
            text-align: center;
            transition: border .5s;
            border: 1px solid rgba(18, 24, 58, 0.06);

            -moz-transition: border .5s;
            /* Firefox 4 */
            -webkit-transition: border .5s;
            /* Safari 和 Chrome */
            -o-transition: border .5s;
            /* Opera */
        }

        .goTop>span:hover {
            border: 1px solid #6680B3;
        }


        .goTop {
            position: fixed;
            right: 30px;
            bottom: 80px;
        }

        .goTop>span>svg {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }

    }

    @media screen and (max-width: 600px) {
        .goTop {
            display: none;
        }
    }
</style>
<div class="goTop" id="js-go_top">
    <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <g>
                <path d="M13 12v8h-2v-8H4l8-8 8 8z"></path>
            </g>
        </svg>
    </span>
</div>
<script>
    $( '#js-go_top' )
	.gotoTop( {
		offset: 500,
		speed: 300,
		animationShow: {
			'transform': 'translate(0,0)',
			'transition': 'transform .5s ease-in-out'
		},
		animationHide: {
			'transform': 'translate(100px,0)',
			'transition': 'transform .5s ease-in-out'
		}
	} );
</script>


    <!-- Gitalk -->
    <script>
        const data = '{"clientID":"02b3c","clientSecret":"adfc7b4","repo":"gimment","owner":"duneng","admin":"duneng"}'
        const gitalk = new Gitalk({
            ...JSON.parse( data),
            id:location.pathname,
            distractionFreeMode:false
        })
        gitalk.render('gitalk-container')
    </script>

<script>
	console.log('\n %c Hexo-Quiet 主题 %c https://github.com/QiaoBug/hexo-theme-quiet \n', 'color: #fadfa3; background: #030307; padding:5px 0;', 'background: #fadfa3; padding:5px 0;')
</script>
	</body>
</html>

